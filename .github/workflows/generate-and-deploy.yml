name: Convert And Deploy Mermaid Diagrams In Markdown To GitHub Pages

# Runs on pushes targeting the default branch
on:
  push:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # Build job
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    # Steps represent a sequence of tasks that will be executed as part of the job steps:
    # Checkout to "generate-diagrams" branch
    steps:
      - name: Checkout generate-diagrams branch
        uses: actions/checkout@v3
        with:
          ref: generate-diagrams

      - name: Reset generate-diagrams branch
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git fetch origin main:main
          git reset --hard main
          
      - name: Generate Diagrams In Markdown Files
        run: |
          for file in $(find . -name '*.md'); do
            [ -f "$file" ] || continue
            npx -p @mermaid-js/mermaid-cli mmdc --input $file
          done
      - name: Show Changes
        run: |
          git status

      # - name: Commit files
      #   run: |
      #     git config --local user.email "action@github.com"
      #     git config --local user.name "GitHub Action"
      #     git add -A 
      #     git commit -m "Add changes" -a

      # - name: Push changes
      #   uses: ad-m/github-push-action@master
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v5
        with:
          branch: generate-diagrams
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: Add compiled mermaid
          title: '[MMDC] New mermaid files compiled'
          body: |
            - Auto-generated by [create-pull-request][1]

            [1]: https://github.com/peter-evans/create-pull-request
          labels: report, automated pr
          assignees: ${{ github.actor }}
          reviewers: ${{ github.actor }}
      - name: Check outputs
        run: |
          echo "Pull Request Number - ${{ env.PULL_REQUEST_NUMBER }}"
          echo "Pull Request Number - ${{ steps.cpr.outputs.pr_number }}"    
